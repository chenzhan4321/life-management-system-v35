<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ´»ç®¡ç†ç³»ç»Ÿ - Palantir æ¶æ„ v2.4 ğŸ”¥ä¿®å¤ç‰ˆ</title>
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç”Ÿæ´»ç®¡ç†">
    <meta name="application-name" content="ç”Ÿæ´»ç®¡ç†ç³»ç»Ÿ">
    <meta name="msapplication-TileColor" content="#007AFF">
    <meta name="msapplication-config" content="./browserconfig.xml">
    
    <!-- iOS Safari æ”¯æŒ -->
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-192x192.png">
    <link rel="apple-touch-startup-image" href="./icon-512x192.png">
    
    <!-- Android Chrome æ”¯æŒ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    
    <!-- ä¸»é¢˜æ ·å¼ -->
    <link id="theme-stylesheet" rel="stylesheet" href="./theme-default.css">
    <!-- ç§»åŠ¨ç«¯å“åº”å¼æ ·å¼ -->
    <link rel="stylesheet" href="./mobile.css">
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
    <div class="theme-switcher">
        <label for="theme-select">ä¸»é¢˜:</label>
        <select id="theme-select" onchange="changeTheme(this.value)">
            <option value="default">é»˜è®¤ macOS</option>
            <option value="dark">æ·±è‰²æ¨¡å¼</option>
        </select>
    </div>
    
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar">
            <div class="nav-brand">
                <span class="logo">ğŸ¯</span>
                <h1>ç”Ÿæ´»ç®¡ç†ç³»ç»Ÿ <span style="font-size: 12px; background: #ff4757; color: white; padding: 2px 6px; border-radius: 3px;">v2.4 ğŸ”¥ä¿®å¤ç‰ˆ</span></h1>
            </div>
            <div class="nav-stats">
                <div class="stat-item">
                    <span class="stat-label">ä»Šæ—¥å®Œæˆ</span>
                    <span class="stat-value" id="todayCompleted">0/0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç”Ÿäº§åŠ›åˆ†æ•°</span>
                    <span class="stat-value" id="productivityScore">0%</span>
                </div>
            </div>
        </nav>

        <!-- AI æ™ºèƒ½ä»»åŠ¡è¾“å…¥ -->
        <div class="ai-input-section">
            <h2>AI æ™ºèƒ½ä»»åŠ¡å¤„ç†</h2>
            <p class="input-hint">
                ğŸ’¡ å•è¡Œè¾“å…¥æ·»åŠ å•ä¸ªä»»åŠ¡ï¼Œå¤šè¡Œæˆ–åˆ†å·åˆ†éš”æ‰¹é‡æ·»åŠ ä»»åŠ¡
            </p>
            <textarea id="aiTaskInput" 
                      placeholder="è¾“å…¥ä»»åŠ¡ï¼ŒAI ä¼šè‡ªåŠ¨åˆ†ç±»ã€é¢„æµ‹æ—¶é—´ã€å®‰æ’æ—¶é—´æ§½...

ç¤ºä¾‹ï¼š
å›å¤ Tony çš„é‚®ä»¶
ç ”ç©¶ OCR é”™è¯¯æ£€æµ‹æ–¹æ³•
æ•´ç†å‡ºå·®ç¥¨æ®ç»™é›ªåªš
æ³•è¯­è€å¸ˆé€šä¿¡30åˆ†é’Ÿ

æˆ–ç”¨åˆ†å·åˆ†éš”ï¼šå›å¤é‚®ä»¶ï¼›æ•´ç†æ–‡æ¡£ï¼›å¼€ä¼šè®¨è®º"
                      rows="6"></textarea>
            <div class="input-actions">
                <button onclick="aiProcessTasks()" class="btn btn-primary">
                    <span class="btn-icon">âœ¨</span> AI æ™ºèƒ½å¤„ç†
                </button>
                <button onclick="clearInput()" class="btn btn-secondary">
                    æ¸…ç©º
                </button>
            </div>
            <div id="aiProcessing" class="ai-processing hidden">
                <div class="loading-spinner"></div>
                <span>AI æ­£åœ¨å¤„ç†...</span>
            </div>
            <div id="processResult" class="process-result hidden"></div>
        </div>
        
        <!-- æ‰‹å·¥å¿«é€Ÿæ·»åŠ  -->
        <div class="manual-input-section">
            <h3>ğŸš€ å¿«é€Ÿæ·»åŠ ä»»åŠ¡</h3>
            <div class="manual-input-flex">
                <input type="text" 
                       id="quickTaskInput" 
                       placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜ï¼ˆæŒ‰Enteræ·»åŠ ï¼‰" 
                       class="quick-task-input"
                       onkeypress="if(event.key==='Enter'){addQuickTask();}">
                <select id="quickTaskDomain" class="quick-task-select">
                    <option value="academic">ğŸ“ å­¦æœ¯</option>
                    <option value="income">ğŸ’° æ”¶å…¥</option>
                    <option value="growth">ğŸŒ± æˆé•¿</option>
                    <option value="life">ğŸ  ç”Ÿæ´»</option>
                </select>
                <input type="number" 
                       id="quickTaskMinutes" 
                       placeholder="åˆ†é’Ÿ" 
                       value="30" 
                       min="5" 
                       max="480"
                       class="quick-task-number">
                <button onclick="addQuickTask()" class="btn btn-primary quick-add-btn">
                    <span class="btn-icon">â•</span> æ·»åŠ 
                </button>
            </div>
        </div>

        <!-- æ—¶é—´åŸŸä»ªè¡¨æ¿ -->
        <div class="domain-dashboard">
            <h2>ä»Šæ—¥æ—¶é—´åŸŸåˆ†é…</h2>
            <div class="domains-grid">
                <div class="domain-card academic" data-domain="academic">
                    <h3>ğŸ“ å­¦æœ¯/è®ºæ–‡</h3>
                    <div class="progress-ring">
                        <svg width="120" height="120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#4285F4" stroke-width="8"
                                    stroke-dasharray="339.292" stroke-dashoffset="339.292"
                                    class="progress-ring-circle" id="academicProgress"/>
                        </svg>
                        <div class="progress-text">
                            <span class="hours">0/4</span>
                            <span class="label">å°æ—¶</span>
                        </div>
                    </div>
                    <div class="domain-tasks" id="academicTasks"></div>
                </div>

                <div class="domain-card income" data-domain="income">
                    <h3>ğŸ’° æ”¶å…¥/æŒ£é’±</h3>
                    <div class="progress-ring">
                        <svg width="120" height="120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#34A853" stroke-width="8"
                                    stroke-dasharray="339.292" stroke-dashoffset="339.292"
                                    class="progress-ring-circle" id="incomeProgress"/>
                        </svg>
                        <div class="progress-text">
                            <span class="hours">0/4</span>
                            <span class="label">å°æ—¶</span>
                        </div>
                    </div>
                    <div class="domain-tasks" id="incomeTasks"></div>
                </div>

                <div class="domain-card growth" data-domain="growth">
                    <h3>ğŸŒ± ä¸ªäººæˆé•¿</h3>
                    <div class="progress-ring">
                        <svg width="120" height="120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#FBBC04" stroke-width="8"
                                    stroke-dasharray="339.292" stroke-dashoffset="339.292"
                                    class="progress-ring-circle" id="growthProgress"/>
                        </svg>
                        <div class="progress-text">
                            <span class="hours">0/4</span>
                            <span class="label">å°æ—¶</span>
                        </div>
                    </div>
                    <div class="domain-tasks" id="growthTasks"></div>
                </div>

                <div class="domain-card life" data-domain="life">
                    <h3>ğŸ  ç”Ÿæ´»çäº‹</h3>
                    <div class="progress-ring">
                        <svg width="120" height="120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#EA4335" stroke-width="8"
                                    stroke-dasharray="339.292" stroke-dashoffset="339.292"
                                    class="progress-ring-circle" id="lifeProgress"/>
                        </svg>
                        <div class="progress-text">
                            <span class="hours">0/4</span>
                            <span class="label">å°æ—¶</span>
                        </div>
                    </div>
                    <div class="domain-tasks" id="lifeTasks"></div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="tasks-section">
            <div class="section-header">
                <h2>ä»Šæ—¥ä»»åŠ¡</h2>
                <div class="action-buttons">
                    <button onclick="toggleSelectAll()" class="btn btn-select-all">
                        <span class="btn-icon">â˜‘ï¸</span> å…¨é€‰
                    </button>
                    <button onclick="deleteSelectedTasks()" class="btn btn-delete-selected" style="display:none;">
                        <span class="btn-icon">ğŸ—‘ï¸</span> åˆ é™¤é€‰ä¸­
                    </button>
                    <button onclick="optimizeSchedule()" class="btn btn-optimize">
                        <span class="btn-icon">ğŸ”„</span> ä¼˜åŒ–æ—¥ç¨‹
                    </button>
                    <button onclick="updateOntology()" class="btn btn-learn">
                        <span class="btn-icon">ğŸ§ </span> AI å­¦ä¹ 
                    </button>
                </div>
            </div>
            <div id="tasksList" class="tasks-list"></div>
        </div>

        <!-- AI æ´å¯Ÿé¢æ¿ -->
        <div class="insights-panel">
            <h3>AI æ´å¯Ÿä¸å»ºè®®</h3>
            <div id="aiInsights" class="insights-content">
                <div class="insight-item">
                    ğŸ’¡ ç³»ç»Ÿæ­£åœ¨å­¦ä¹ æ‚¨çš„å·¥ä½œæ¨¡å¼...
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>

    <!-- PWAå®‰è£…æç¤º -->
    <div id="pwa-install-banner" class="pwa-install-banner" style="display: none;">
        <div class="pwa-banner-content">
            <span>ğŸš€ å®‰è£…ç”Ÿæ´»ç®¡ç†ç³»ç»Ÿåˆ°æ‚¨çš„è®¾å¤‡</span>
            <div class="pwa-banner-actions">
                <button id="pwa-install-btn" class="btn btn-primary">å®‰è£…</button>
                <button id="pwa-dismiss-btn" class="btn btn-secondary">ç¨å</button>
            </div>
        </div>
    </div>

    <script src="./app.js?v=20250825-5-FIXED"></script>
    
    <!-- PWAæ”¯æŒè„šæœ¬ -->
    <script>
        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                        
                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æ˜¾ç¤ºæ›´æ–°æç¤º
                                    showUpdateNotification(registration);
                                }
                            });
                        });
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWAå®‰è£…æç¤ºå¯ç”¨');
            e.preventDefault();
            deferredPrompt = e;
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æ¨ªå¹…
            const installBanner = document.getElementById('pwa-install-banner');
            const installBtn = document.getElementById('pwa-install-btn');
            const dismissBtn = document.getElementById('pwa-dismiss-btn');
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¹‹å‰æ‹’ç»è¿‡å®‰è£…
            const dismissed = localStorage.getItem('pwa-install-dismissed');
            if (!dismissed) {
                installBanner.style.display = 'block';
                setTimeout(() => {
                    installBanner.classList.add('show');
                }, 100);
            }
            
            installBtn.addEventListener('click', async () => {
                installBanner.style.display = 'none';
                deferredPrompt.prompt();
                
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`ç”¨æˆ·é€‰æ‹©: ${outcome}`);
                
                if (outcome === 'accepted') {
                    showToast('ğŸ‰ åº”ç”¨å®‰è£…æˆåŠŸï¼', 'success');
                } else {
                    localStorage.setItem('pwa-install-dismissed', 'true');
                }
                
                deferredPrompt = null;
            });
            
            dismissBtn.addEventListener('click', () => {
                installBanner.style.display = 'none';
                localStorage.setItem('pwa-install-dismissed', 'true');
                
                // 7å¤©åå†æ¬¡æ˜¾ç¤º
                setTimeout(() => {
                    localStorage.removeItem('pwa-install-dismissed');
                }, 7 * 24 * 60 * 60 * 1000);
            });
        });

        // åº”ç”¨å®‰è£…å®Œæˆ
        window.addEventListener('appinstalled', () => {
            console.log('PWA å®‰è£…å®Œæˆ');
            showToast('ğŸ‰ åº”ç”¨å·²æ·»åŠ åˆ°ä¸»å±å¹•ï¼', 'success');
            localStorage.removeItem('pwa-install-dismissed');
        });

        // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
        function showUpdateNotification(registration) {
            const updateToast = document.createElement('div');
            updateToast.className = 'toast toast-update';
            updateToast.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>ğŸ”„ åº”ç”¨æœ‰æ–°ç‰ˆæœ¬å¯ç”¨</span>
                    <div>
                        <button onclick="updateApp('${registration}')" class="btn btn-primary btn-small">æ›´æ–°</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-secondary btn-small">ç¨å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(updateToast);
            
            setTimeout(() => {
                updateToast.classList.add('show');
            }, 100);
        }

        // æ›´æ–°åº”ç”¨
        function updateApp(registration) {
            const worker = registration.waiting;
            worker.postMessage({ type: 'SKIP_WAITING' });
            
            worker.addEventListener('statechange', () => {
                if (worker.state === 'activated') {
                    window.location.reload();
                }
            });
        }

        // å¤„ç†ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', () => {
            showToast('ğŸŒ ç½‘ç»œå·²è¿æ¥', 'success');
            // è§¦å‘åå°åŒæ­¥
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('background-sync-tasks');
                });
            }
        });

        window.addEventListener('offline', () => {
            showToast('ğŸ“± ç¦»çº¿æ¨¡å¼ - æ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤æ—¶åŒæ­¥', 'info');
        });

        // æ£€æµ‹æ˜¯å¦ä¸ºPWAæ¨¡å¼è¿è¡Œ
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
            console.log('åœ¨PWAæ¨¡å¼ä¸‹è¿è¡Œ');
            document.body.classList.add('pwa-mode');
        }
    </script>

    <!-- PWAæ ·å¼ -->
    <style>
        .pwa-install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #007AFF, #0051D2);
            color: white;
            padding: 15px 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        .pwa-install-banner.show {
            transform: translateY(0);
        }

        .pwa-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 600px;
            margin: 0 auto;
        }

        .pwa-banner-actions {
            display: flex;
            gap: 10px;
        }

        .pwa-banner-actions .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .pwa-banner-actions .btn-primary {
            background: white;
            color: #007AFF;
        }

        .pwa-banner-actions .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .toast-update {
            background: #4CAF50;
            color: white;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1001;
        }

        .btn-small {
            padding: 4px 8px !important;
            font-size: 12px !important;
            margin-left: 5px;
        }

        /* PWAæ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
        .pwa-mode {
            /* ä¸ºPWAæ¨¡å¼æ·»åŠ ç‰¹æ®Šæ ·å¼ */
        }

        @media (max-width: 768px) {
            .pwa-banner-content {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .pwa-banner-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</body>
</html>